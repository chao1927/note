# 1. Redis 数据结构

### 4. 跳表

1. ##### 简介

**跳表(skiplist)** 是一种有序数据结构，它通过在每个节点维持多个指向其他节点的指针，从而达到快速访问节点的目的。

跳表支持**平均 O(logN)、最坏 O(N) 复杂度**的节点查找，还可以通过顺序性操作来批量处理节点。

在大部分情况下，跳表的效率可以和平衡树媲美，并且因为跳表的实现比平衡树要来得更为简单，所有有不少程序都使用跳表来代替平衡树。

Redis 使用跳表作为有序集合 ZSET (SORTED SET) 的底层实现之一，如果一个有序集合包含的元素数量比较多，又或者有序集合中的元素成员 (member) 是比较长

的字符串时，Redis 就会使用跳表来作为有序集合键的底层实现。

2. ##### 应用

- 实现有序集合
- 在集群节点中用作内部数据结构



3. ##### 跳表介绍

![redis-Redis 跳表](D:%5Cnote%5Credis%5Credis-Redis%20%E8%B7%B3%E8%A1%A8.png)

跳表：通过增加索引层，减少每一次查询时遍历的元素个数，从而加快查询的速度。类似于二分查找的方式。

原始元素每一次建立索引时所跨越的元素个数:
$$
p
$$
索引层数：
$$
h = log_pn
$$
跳表中的每一层索引中的元素节点被加入到该层索引的概率：
$$
P = 1- 1/p^h
$$
计算元素生成索引概率源码：

```java
// 该 randomLevel 方法会随机生成 1~MAX_LEVEL 之间的数，且 ：
//        1/2 的概率返回 1
//        1/4 的概率返回 2
//        1/8 的概率返回 3 以此类推
private int randomLevel() {
  int level = 1;
  // 当 level < MAX_LEVEL，且随机数小于设定的晋升概率时，level + 1
  while (Math.random() < SKIPLIST_P && level < MAX_LEVEL)
    level += 1;
  return level;
}
```



4. Redis 中跳表的实现

![redis-Redis中跳表的实现](D:%5Cnote%5Credis%5Credis-Redis%E4%B8%AD%E8%B7%B3%E8%A1%A8%E7%9A%84%E5%AE%9E%E7%8E%B0.png)

1. zskiplist

- header

    指向跳表表头的指针

- tail

    指向跳表表尾的指针

- level

    记录目前跳表内，层数最大的那个节点的层数 （表头节点的层数计算在内）

- length

    记录跳表的长度，包含元素的数量

2. zskiplistNode

- level 层

    跳表索引层的高度，加速访问元素

- forward 前进指针

    向表尾方向访问下一个元素的指针

- span 跨度

    计算同一层中两个节点之间包含的元素的数量，可以用于计算元素节点排位

- backward 后退指针

    向表头方向访问上一个元素的指针

- score 分值

    分值用来节点排序，保证元素节点顺序性

- robj 成员

    实际节点保存的值