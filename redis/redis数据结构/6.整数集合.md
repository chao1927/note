# 1. Redis 数据结构

### 5. 整数集合

整数集合是集合键的底层实现之一，当一个集合只包含整数数值元素时，并且这个集合的元素数量不多时，Redis 就会使用整数集合作为集合键的底层实现。它可

以保存类型为 int16_t，int32_t 或者 int64_t 的整数值，并且保证集合中不会出现重复元素，且集合中保存的元素是有序的。



1. ##### 整数集合的实现

```
typedef struct intset {
	
	// 编码方式
	uint32_t encoding;
	
	// 集合包括的元素数量
	uint32_t length;
	
	// 保存元素的数组
	int8_t contents;

} intset;
```

![redis-Redis整数集合](D:%5Cnote%5Credis%5Credis-Redis%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88.png)



- length 属性

    记录了整数集合包含的元素数量，contents 数组的长度

- enconding 属性

    记录了 contents 数组中保存的元素的数据类型，如：

    - int16_t (-32768 - 32767)
    - int32_t (-2147483648-2147483647)
    - int64_t (-9223372036854775808-9223372036854775807)

- contents 属性

    实际保存数据元素的数组

2. ##### 当 encoding 编码升级

1). 根据新元素的类型，扩展整数集合底层数组空间的大小，并且为新元素分配空间。

2). 将底层数组现有的所有元素都转换成与新元素相同的类型，并且将类型转换后的元素放置到正确的位上，而且在放置元素的过程中，需要继续维持底层数组的

有序性质不变。

3). 将新元素添加到底层数组里面。

3. ##### 升级的好处

- 提升灵活性
- 节约内存

4. ##### 降级

整数集合不支持降级操作，一旦对数组进行了升级，编码就会一直保存升级之后的状态。