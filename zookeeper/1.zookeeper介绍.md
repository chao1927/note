## Zookeeper

##### 1. 介绍

ZooKeeper 是用来在分布式系统中协作多个任务的。

一个协作任务是指一个包含多个进程的任务。这个任务可以是为了**协作**或者是为了**管理竞争**。

- 协作意味着多个进程需要一同处理某些事情，一些进程采取某些行动使得其他进程可以继续工作。
- 竞争是指两个进程不能同时处理工作的情况，一个进程必须等待另一个进程。



ZooKeeper 客户端 API 功能包括：

- 保障强一致性，有序性和持久性。
- 实现通用的同步原语的能力。
- 在实际分布式系统中，并发往往导致不正确的行为。ZooKeeper 提供了一种简单的并发处理机制。



##### 2.  分布式系统定义：

分布式系统是同时跨越多个物理主机，独立运行的多个软件组件所组成的系统。



分布式系统中的进程通信的两种方式：

1. 直接通过网络进行信息交换。
2. 读写某些共享存储。



分布式系统中的一些问题

- 消息延迟
- 处理器性能
- 时钟偏移

这些问题会导致我们很难判断是那些原因导致了延时。



##### 3. 主从应用

主从模式的系统的三个关键问题：

1. 主节点崩溃

    需要使用备份主节点进行故障转移，

2. 从节点崩溃

    主节点必须能够检测到从节点的崩溃，并确定哪些从节点是否有效以便派发崩溃节点的任务。

3. 通信故障

    - 网络分区
    - 锁资源释放



主从架构需求：

- 主节点选举
- 崩溃检测
- 集群管理（组成员关系管理）
- 元数据管理



##### 4. zookeeper 数据存储结构

![zookeeper存储数据结构](D:%5Cnote%5Czookeeper%5Czookeeper%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png)

Zookeeper 操作和维护一个小型的数据节点，这些节点被称为 znode。采用类似于文件系统的层级树状结构进行管理。



**4.1 znode 节点介绍**

znode 节点肯包含数据，也可能没有。znode 节点包含的数据存储为字节数组，zookeeper 不允许局部写入或读取 znode 节点的数据。当设置一个 znode 节点的

数据或读取时，znode 节点的内容会被整个替换或者全部读取进来。

- **znode 操作 API**

```
# 创建一个名为 /path 的 znode 节点，并包含数据 data。
create /path data

# 删除名为 /path 的 znode
delete /path

# 检查是否存在名为 /path 的节点
exist /path

# 设置名为 /path 的 znode 的数据为 data
setData /path data

# 返回名为 /path 节点的数据信息
getData /path

# 返回所有 /path 节点的所有子节点列表






getChildren /path
```



- **znode 类型**

    - 持久节点

    - 临时节点

        在以下两种情况下将会被删除：

        1. 当创建该 znode 的客户端的会话因超时或主动关闭而中止时。
        2. 当某个客户端（不一定是创建者）主动删除该节点时。

    - 持久 + 有序节点

    - 临时 + 有序节点



- 监视与通知 watch